<!doctype html>
<html class="no-js" manifest="appcache.manifest" ng-app="md5htmlApp">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>Offline MD5 Calculator</title>
  <meta name="description" content="It calculates MD5 digest of the given files without using any server side processing.  It uses html5 File API and MD5 library (made by Cybozu Labs, Inc.)"/>
  <meta name="viewport" content="width=device-width"/>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/picnicss/4.1.1/picnic.min.css">
  <link rel="stylesheet" href="src/main.css">
  <script src="elm.js"></script>
  <script src="src/bower_components/md5/index.js"></script>
</head>
<body>
</body>
<script>
  var engine = CybozuLabs.MD5;
  var app = Elm.fullscreen(Elm.Md5html, {file: { name: '', md5: ''}});
  var ff = document.querySelector('#ff');
  ff.addEventListener('change', handleFiles, false );
  function handleFiles() {
    addFiles( this.files );
  }
  function addFiles( files ) {
    var arrFiles = [].slice.call( files );
    console.log('file(s) added: ', arrFiles );
    arrFiles.forEach(function( file ) {
      app.ports.file.send({ name: file.name, md5: '...'});
      var reader = new window.FileReader();
      reader.onload = function( ev ) {
        var md5 = engine.calc( ev.target.result );
        app.ports.file.send({ name: file.name, md5: md5 });
      };
      reader.onerror = function() {
        console.log('onerror callded');
      };
      reader.readAsBinaryString( file );
    });
  }
  var dropbox = document.querySelector('#dropbox');
  dropbox.addEventListener('click', function() {
    ff.click();
  }, false);
  dropbox.addEventListener('dragover', cancelEvent, false);
  dropbox.addEventListener('drop', handleFileDrop, false);
  function cancelEvent(ev) {
    ev.stopPropagation();
    ev.preventDefault();
  };
  function handleFileDrop(ev) {
    cancelEvent( ev );
    console.log('drop', ev );
    addFiles( ev.dataTransfer.files );
  };
  // Blob handling
  function updateURL( files ) {
    if (files.some(function(f) { return f.md5 == '...'; })) { return; }
    console.log('md5 ports updated: ', files );
    var URL = window.URL || window.webkitURL;
    var txt = files.map(function(f) { return f.name + ', ' + f.md5; }).join('\n');
    var url = URL.createObjectURL( new window.Blob([ txt ], {type: 'text/plain'}) );
    document.querySelector('#download').setAttribute('href', url);
  }
  app.ports.md5.subscribe( updateURL );
</script>
<script>
  (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
  function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
  e=o.createElement(i);r=o.getElementsByTagName(i)[0];
  e.src='//www.google-analytics.com/analytics.js';
  r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
  ga('create','UA-40934119-1');ga('send','pageview');
</script>
</html>
